const fs = require('fs');
const path = require('path');

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ¾Ğ½ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ·Ğ°Ğ¼ĞµĞ½
let transcriptions = {};
try {
    const transcriptionsPath = path.join(__dirname, 'transcriptions.json');
    if (fs.existsSync(transcriptionsPath)) {
        transcriptions = JSON.parse(fs.readFileSync(transcriptionsPath, 'utf8'));
        console.log('âœ… Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ñ„Ğ¾Ğ½ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ·Ğ°Ğ¼ĞµĞ½:', Object.keys(transcriptions).length);
    }
} catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ transcriptions.json:', error);
}

const botBehavior = {
    // ============================================
    // Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞĞ«Ğ™ ĞŸĞ ĞĞœĞŸĞ¢
    // ============================================
    systemPrompt: (context) => `Ğ¢Ñ‹ â€” ×”×¢×•×–×¨×ª ×”××™×©×™×ª (Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ñ†Ğ°) ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ Leader.
  Ğ¢Ğ²Ğ¾Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ñ â€” Ğ¶ĞµĞ½ÑĞºĞ¸Ğ¹. Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ğ¾ ÑĞµĞ±Ğµ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ² Ğ¶ĞµĞ½ÑĞºĞ¾Ğ¼ Ñ€Ğ¾Ğ´Ğµ Ğ½Ğ° Ğ²ÑĞµÑ… ÑĞ·Ñ‹ĞºĞ°Ñ….

  Ğ¢Ğ•ĞšĞ£Ğ©Ğ•Ğ• Ğ’Ğ Ğ•ĞœĞ¯/Ğ”ĞĞ¢Ğ: ${context.currentDate || '2026-01-26'}.
  ĞŸĞĞ› Ğ¡ĞĞ‘Ğ•Ğ¡Ğ•Ğ”ĞĞ˜ĞšĞ: ${context.gender || 'Ğ½Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½'}. (Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½, Ğ½Ğ°Ñ‡Ğ½Ğ¸ Ñ [GENDER: male/female]).
  Ğ¢Ğ•Ğ›Ğ•Ğ¤ĞĞ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ: ${context.userPhone || 'Ğ½Ğµ Ğ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½'}.

  ğŸš¨ ĞĞĞ’Ğ«Ğ• Ğ’ĞĞ—ĞœĞĞ–ĞĞĞ¡Ğ¢Ğ˜ (MEDIA & STYLE):
  Ğ’ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ Ğ½Ğ¸Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ñ:
  - "Bot Instruction": Ğ¡Ğ»ĞµĞ´ÑƒĞ¹ ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ‚Ğ¾Ğ½Ñƒ (ÑˆÑƒÑ‚Ğ¸, Ğ±ÑƒĞ´ÑŒ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ¸ Ñ‚.Ğ´.).
  - "Images" / "Video": Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑÑÑ‹Ğ»ĞºĞ¸, ÑĞºĞ°Ğ¶Ğ¸: "Ğ¯ Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ² WhatsApp". Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ñ…Ğ¾Ñ‡ĞµÑ‚ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ 'send_whatsapp_message'.

  ğŸ“‹ Ğ¡Ğ‘ĞĞ  Ğ”ĞĞĞĞ«Ğ¥ (Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™ ĞŸĞ ĞĞ”ĞĞ–):
  
  ğŸ“ Ğ•Ğ¡Ğ›Ğ˜ Ğ˜ĞĞ¢Ğ•Ğ Ğ•Ğ¡Ğ£Ğ®Ğ¢ Ğ¯Ğ¥Ğ¢Ğ«:
  1. Ğ’Ñ‹ÑÑĞ½Ğ¸ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸:
     - "×œ×›××” ××©×ª×ª×¤×™×?" (Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ»ÑĞ´ĞµĞ¹?)
     - "×‘××™×–×• ×¢×™×¨ - ×”×¨×¦×œ×™×” ××• ×—×™×¤×”?" (Ğ“ĞµÑ€Ñ†Ğ»Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ¥Ğ°Ğ¹Ñ„Ğ°?)
     - "×œ××™×–×” ×ª××¨×™×š?" (ĞĞ° ĞºĞ°ĞºÑƒÑ Ğ´Ğ°Ñ‚Ñƒ?)
  2. ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.
  3. ĞĞ• ĞŸĞ Ğ•Ğ”Ğ›ĞĞ“ĞĞ™ Ğ‘Ğ ĞĞĞ¬/Ğ’Ğ¡Ğ¢Ğ Ğ•Ğ§Ğ£ Ğ¡Ğ ĞĞ—Ğ£. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ñ†ĞµĞ½Ğµ Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾.
  4. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ/Ğ¿Ñ€Ğ¸Ğ¹Ñ‚Ğ¸ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ 'check_availability' Ğ¸Ğ»Ğ¸ Ğ±ĞµÑ€Ğ¸ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹.

  ğŸ’³ Ğ•Ğ¡Ğ›Ğ˜ Ğ˜ĞĞ¢Ğ•Ğ Ğ•Ğ¡Ğ£Ğ®Ğ¢ Ğ¢Ğ•Ğ ĞœĞ˜ĞĞĞ›Ğ«/ĞšĞĞ¡Ğ¡Ğ«:
  1. Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸: "Ğ”Ğ»Ñ ĞºĞ°ĞºĞ¾Ğ³Ğ¾ Ğ±Ğ¸Ğ·Ğ½ĞµÑĞ°?" Ğ¸ "Ğ’ ĞºĞ°ĞºĞ¾Ğ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ?".
  2. ĞĞ´Ñ€ĞµÑ Ğ¾Ñ„Ğ¸ÑĞ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ÑĞ¿Ñ€Ğ¾ÑÑÑ‚): ×”×¨×¦×œ×™×”, ×¨×—' ××¨×™×§ ××™×™× ×©×˜×™×™×Ÿ, ××¡' 3.

  ğŸ“ Ğ¢ĞĞ§ĞĞ«Ğ• ĞĞ”Ğ Ğ•Ğ¡Ğ Ğ¯Ğ¥Ğ¢ (Ğ—ĞĞĞ™ ĞĞĞ˜Ğ—Ğ£Ğ¡Ğ¢Ğ¬):
  - Ğ¥ĞĞ™Ğ¤Ğ: ××¢×’×Ÿ ×”×“×™×™×’ ×©×‘×™×˜ , ×œ×™×“ ×¤××¨×§ ×§×™×©×•×Ÿ
  - Ğ“Ğ•Ğ Ğ¦Ğ›Ğ˜Ğ¯: ××¨×™× ×” ×”×¨×¦×œ×™×”, ×œ×™×“ ×§× ×™×•×Ÿ ××¨× ×”

  ğŸš¨ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ ĞŸĞĞ’Ğ•Ğ”Ğ•ĞĞ˜Ğ¯:
  - Ğ—ĞĞŸĞ Ğ•Ğ¢ ĞĞ Ğ’Ğ«Ğ”Ğ£ĞœĞ«Ğ’ĞĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†ĞµĞ½Ñ‹ Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹.
  - ĞœĞ£Ğ›Ğ¬Ğ¢Ğ˜Ğ¯Ğ—Ğ«Ğ§ĞĞĞ¡Ğ¢Ğ¬: Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ğ½Ğ° Ğ˜Ğ’Ğ Ğ˜Ğ¢Ğ•. ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞµÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» ("Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸").
  - ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ“ĞĞ”Ğ: Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ 2026 Ğ³Ğ¾Ğ´Ğ¾Ğ¼.
  - ĞŸĞĞ Ğ¦Ğ˜Ğ˜: ĞÑ‚Ğ²ĞµÑ‚ Ğ½Ğµ Ğ´Ğ»Ğ¸Ğ½Ğ½ĞµĞµ 3-4 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹. Ğ’ÑĞµĞ³Ğ´Ğ° Ğ·Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼.

  ---------------------------------------------
  ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ Ğ˜Ğ— Ğ‘ĞĞ—Ğ« Ğ—ĞĞĞĞ˜Ğ™:
  ${context.text || 'ĞĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸.'}
  ---------------------------------------------
  `,

    // ============================================
    // ĞŸĞ Ğ˜Ğ’Ğ•Ğ¢Ğ¡Ğ¢Ğ’Ğ˜Ğ•
    // ============================================
    greetings: {
        initial: '×©×œ×•×, ×”×’×¢×ª× ×œ×—×‘×¨×ª ×œ×™×“×¨, ×× ×™ ×”×¢×•×–×¨×ª ×”××™×©×™×ª. ××™×š ××¤×©×¨ ×œ×¢×–×•×¨?',
    },

    // ============================================
    // Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯
    // ============================================
    messages: {
        checking: '×¨×§ ×¨×’×¢, ×× ×™ ×‘×•×“×§×ª...',
        noSpeech: '×œ× ×©××¢×ª×™, ××¤×©×¨ ×œ×—×–×•×¨?',
        apiError: '×™×© ×ª×§×œ×” ×§×˜× ×”, × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨',
        transferring: '××¢×‘×™×¨×” ××•×ª×š ×œ× ×¦×™×’, ×”××ª×Ÿ ×¨×’×¢.',
        waitMusicUrl: 'https://mabotmusik-2585.twil.io/mb.mp3', // Ğ’Ğ°ÑˆĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°
    },

    // ============================================
    // ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Ğ“ĞĞ›ĞĞ¡Ğ (Ğ’ĞĞ¨Ğ˜ Ğ¡Ğ¢ĞĞ Ğ«Ğ•, ĞŸĞ ĞĞ’Ğ•Ğ Ğ•ĞĞĞ«Ğ•)
    // ============================================
    voiceSettings: {
        he: {
            language: 'he-IL',
            ttsVoice: 'Google.he-IL-Standard-A',
            sttLanguage: 'iw-IL',
        },
        ru: {
            language: 'ru-RU',
            ttsVoice: 'Google.ru-RU-Wavenet-A',
            sttLanguage: 'ru-RU',
        }
    },

    gatherSettings: {
        input: 'speech',
        speechTimeout: 'auto',
        language: 'iw-IL', // Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° (iw-IL)
    },

    geminiSettings: {
        model: 'gemini-2.0-flash',
        temperature: 0.2, 
    },

    operatorSettings: {
        phoneNumber: '+972533403449',
        timeout: 20,
        callbackUrl: 'https://api.leadertechnology.shop/handle-dial-status',
    },

    textCleanupRules: {
        markdownSymbols: /[*_#`~]/g,
        punctuation: /[.,!?;:"""''()[\]{}]/g,
        multipleSpaces: /\s+/g,
    },

    // ============================================
    // Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
    // ============================================

    detectLanguage(text) {
        if (!text) return 'he';
        const lower = text.toLowerCase();
        // Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€ÑƒÑÑĞºĞ¾Ğ³Ğ¾ (Ğ¸Ğ· ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°)
        const russianKeywords = ['russian', 'rusit', '×‘×¨×•×¡×™×ª', '×¨×•×¡×™×ª', 'Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸'];
        if (/[\u0400-\u04FF]/.test(text) || russianKeywords.some(k => lower.includes(k))) return 'ru';
        return 'he';
    },

    cleanTextForTTS(text) {
        text = text.replace(this.textCleanupRules.markdownSymbols, '');
        text = text.replace(/<[^>]*>/g, ''); // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ñ‚ĞµĞ³Ğ¸
        text = text.replace(this.textCleanupRules.multipleSpaces, ' ').trim();

        Object.keys(transcriptions).forEach(word => {
            if (text.includes(word)) {
                const replacement = transcriptions[word];
                const regex = new RegExp(word, 'g');
                text = text.replace(regex, replacement);
            }
        });
        return text;
    },

    getSystemPrompt(context, gender = null, currentDate = null, userPhone = null) {
        return this.systemPrompt({ text: context, gender: gender, currentDate: currentDate, userPhone: userPhone });
    },

    getGreeting() { return this.greetings.initial; },

    getMessage(type) {
        return this.messages[type] || this.greetings[type] || '×©×’×™××” ×‘××¢×¨×›×ª';
    },
};

module.exports = botBehavior;